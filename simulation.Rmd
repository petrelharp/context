# Results from fitting procedure

*Invocation:*
```{r, echo=FALSE}
library(pander)
library(ggplot2)
panderOptions("table.split.table", Inf)  # Let tables become arbitrarily wide rather than wrapping.
source("context-inference-fns.R")
top_n_bottom <- function(df, k) { # Take the top and bottom k rows
    n = nrow(df)
    if(2*k < n) {
        df[c(1:k,(n-(k-1)):n), ]
    }
    else {
        df
    }
}
counts_table <- function(in_longwin, in_shortwin, half_n_show) {
    if ( in_longwin > longwin(model@counts) || in_shortwin > shortwin(model@counts) ) {
        cat("Window size of counts too small.")
    }
    else {
        resids = computeresids(model,
                in_longwin=in_longwin,
                in_shortwin=in_shortwin,
                in_leftwin=in_shortwin,
                counts=model@counts)
        pandoc.table(top_n_bottom(resids, half_n_show), style="rmarkdown")
    }
}
cat(model@invocation)
```


## Fitted parameter values
```{r, echo=FALSE, results="asis"}
mr_compare <- data.frame(fit=model@mutrates / time)
mr_compare$names <- rownames(mr_compare)
simvalues= data.frame(names=mutnames(simseq.config$tip$mutpats), 
                      simulated=simseq.config$tip$mutrates)
mr_compare <- merge(simvalues, mr_compare)
pandoc.table(mr_compare, style="rmarkdown")
```

The corresponding plot, where bars are the simulated values, and points are the fit values:
```{r, echo=FALSE, results="asis"}
ggplot(mr_compare, aes(x=names)) +
    geom_bar(aes(y=fit), stat = "identity", fill="white", color="gray") + 
    geom_point(aes(y=simulated)) +
    theme(axis.text.x = element_text(angle = 90),
          axis.title.y = element_blank())
```


## Window sizes and amount of data used to fit
```{r, echo=FALSE, results="hide"}
# For some reason the code doesn't work if we don't print out some of the
# counts, but we can do it in a hidden block.
counts <- model@counts@counts
head(counts)
```


```{r, echo=FALSE}
cat("left window size:", model@counts@leftwin,
    "\ncomplete window size:", nchar(rownames(counts)[[1]]),
    "\ntotal counts:", sum(counts))
```


## Result of fitting operation
```{r, echo=FALSE}
cat("convergence: ", model@results$convergence,
    "\nmessage: ", model@results$message)
```

## residuals for 2-2 Tmers
```{r, echo=FALSE, results="asis"}
counts_table(in_longwin=2, in_shortwin=2, half_n_show=5)
```

## residuals for 3-1 Tmers
```{r, results="asis"}
counts_table(in_longwin=3, in_shortwin=1, half_n_show=5)
```

## residuals for 9-5 Tmers
```{r, results="asis"}
counts_table(in_longwin=9, in_shortwin=5, half_n_show=5)
```

